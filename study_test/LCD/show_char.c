#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <string.h>
#include <errno.h>
#include <string.h>
#include <sys/mman.h>
#include <linux/fb.h>
#define FB_DEV "/dev/fb0" //LCD 设备节点
static int width; //LCD 宽度
static int height; //LCD 高度
static unsigned short *screen_base = NULL;//LCD 显存基地址
static unsigned char ch_char1[86][8] = 
    { 
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07},
        {0x00,0x00,0x00,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0x00,0x00,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0x00,0x00,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0x00,0x00,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0x00,0x00,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0x00,0x00,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0x00,0x00,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0xFF,0xFF,0xFF,0x01},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
        {0x00,0xFC,0x07,0xC0,0x7F,0x00,0x00,0x00},
    }
/********************************************************************
* 函数名称： lcd_draw_character
* 功能描述： 在 LCD 屏指定位置处(x, y)画字符, 参数 color 指定字符的颜色
 指针 ch 指向字符对应的子模数组、参数 w、h 分别表示字符的宽度和高度
* 输入参数： color
* 返 回 值： 无
********************************************************************/
static void lcd_draw_character(unsigned int x, unsigned int y,
    const unsigned char *ch, unsigned int w,unsigned int h, unsigned int color) 
{
    unsigned long temp;
    unsigned int end_x, end_y;
    int j;
    int columns;
    /**
    计算出二维数组有多少列
    参数 w 表示的是字符的宽度，1 个宽度表示的是 1 个 bit 位
    并不是一个字节，这里要注意，如果宽度不是 byte 单位的整数倍
    通常会补零
    **/
    columns = w / 8; //1byte=8bit
    if (0 != w % 8) columns++;
    /* 对参数进行限定 */
    if (w < 1 || h < 1) return;
    if (x >= width || y >= height) return;
    /* 计算出结束坐标位置 */
    end_x = x + w - 1;
    end_y = y + h - 1;
    /* 对结束坐标位置进行限定 */
    if (end_x >= width)
        end_x = width - 1;
    if (end_y >= height)
        end_y = height - 1;
    /* 计算有效宽度 */
    h = end_y - y + 1;
    w = end_x - x + 1;
    /* 打点 */
    temp = y * width + x; //定位到起点
    for (y = 0; y < h; y++, temp += width) 
    {
        for (x = 0, j = 0; x < w; ) 
        {
            if (*(ch + y * columns + j) & (0x1 << (x % 8)))
                screen_base[temp + x] = rgb565_color;
            x++;
            if (0 == x % 8) j++;
        }
    } 
}
int main(void) 
{
    struct fb_var_screeninfo fb_var = {0};
    struct fb_fix_screeninfo fb_fix = {0};
    unsigned long screen_size;
    int fd;
    /* 打开 framebuffer 设备 */
    fd = open(FB_DEV, O_RDWR);
    if (0 > fd) 
    {
        fprintf(stderr, "open error: %s: %s\n", FB_DEV, strerror(errno));
        exit(EXIT_FAILURE);
    }
    /* 获取 framebuffer 设备信息 */
    ioctl(fd, FBIOGET_VSCREENINFO, &fb_var);
    ioctl(fd, FBIOGET_FSCREENINFO, &fb_fix);
    screen_size = fb_fix.line_length * fb_var.yres;
    width = fb_var.xres;
    height = fb_var.yres;
    /* 内存映射 */
    screen_base = mmap(NULL, screen_size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
    if (MAP_FAILED == (void *)screen_base) 
    {
        perror("mmap error");
        close(fd);
        exit(EXIT_FAILURE);
    }
    /* LCD 背景刷白 */
    memset(screen_base, 0xFF, screen_size);
    /* 显示字符 */
    int x = width * 0.5 - 128;
    int y = height * 0.5 - 43;
    lcd_draw_character(x, y, (unsigned char *)ch_char1, 64, 86, 0xFF00FF);
    /* 退出程序 */
    munmap(screen_base, screen_size);
    close(fd);
    return 0; 
}